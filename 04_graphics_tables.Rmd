---
title: "graphics_tables"
author: "Leandro Pereira Garcia"
date: "October 10, 2019"
output: 
  word_document: 
    reference_docx: TESEv.06.docx
    fig_caption: yes
    fig_height: 8
    fig_width: 12
    toc: no
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
options(scipen=999)
set.seed(233)
```


```{r include=FALSE}
#Libraries
library(readr)
library(tidyverse)
library(ggplot2)
library(sf)
library(spData)
library(ggpubr)
library(RColorBrewer)
library(gt)
```


```{r include=FALSE}
#Databases
pred <- read_csv("bases/impact_predictions.csv")
base_efi <- read_csv("bases/efficiency_analysis.csv")
```







```{r include=FALSE}
#Importing the world map
WorldData <- map_data('world')
WorldData %>% filter(region != "Antarctica") -> WorldData
WorldData <- fortify(WorldData)



#Adjustin countries names
pred$region_map <- pred$LOCATION
pred[which(pred$LOCATION == "Congo, Rep."), 55] <- "Republic of Congo"
pred[which(pred$LOCATION == "Egypt, Arab Rep."), 55] <- "Egypt"
pred[which(pred$LOCATION == "Korea, Rep."), 55] <- "South Korea"
pred[which(pred$LOCATION == "North Macedonia"), 55] <- "Macedonia"
pred[which(pred$LOCATION == "Russian Federation"), 55] <- "Russia"
pred[which(pred$LOCATION == "Trinidad and Tobago"), 55] <- "Trinidad"
pred[which(pred$LOCATION == "United Kingdom"), 55] <- "UK"
pred[which(pred$LOCATION == "United States"), 55] <- "USA"
pred[which(pred$LOCATION == "Brunei Darussalam"), 55] <- "Brunei"
pred[which(pred$LOCATION == "Congo, Dem. Rep."), 55] <- "Democratic Republic of the Congo"
pred[which(pred$LOCATION == "Gambia, The"), 55] <- "Gambia"
pred[which(pred$LOCATION == "Cote d'Ivoire"), 55] <- "Ivory Coast"
pred[which(pred$LOCATION == "Iran, Islamic Rep."), 55] <- "Iran"
pred[which(pred$LOCATION == "Kyrgyz Republic"), 55] <- "Kyrgyzstan"
pred[which(pred$LOCATION == "Lao PDR"), 55] <- "Laos"
pred[which(pred$LOCATION == "Slovak Republic"), 55] <- "Slovakia"
pred[which(pred$LOCATION == "Yemen, Rep."), 55] <- "Yemen"



# teste <- WorldData[,c(3,5)]
# teste$BASE <- "word"
# teste <- unique(teste[,c(2,3)])
# names(teste)[1] <- "region_map"
# pred_t <- pred[,c(2,52)]
# pred_t$BASE <- "pred"
# pred_t$INCOME_CLASS <- NULL
# teste <- merge(teste, pred_t, by = "region_map", all = T)

pred_map <- pred
pred_map <- merge(pred_map, WorldData, by.x = "region_map", by.y = "region", all.x = T)


base_efi$region_map <- base_efi$LOCATION
base_efi[which(base_efi$LOCATION == "Congo, Rep."), 63] <- "Republic of Congo"
base_efi[which(base_efi$LOCATION == "Egypt, Arab Rep."), 63] <- "Egypt"
base_efi[which(base_efi$LOCATION == "Korea, Rep."), 63] <- "South Korea"
base_efi[which(base_efi$LOCATION == "North Macedonia"), 63] <- "Macedonia"
base_efi[which(base_efi$LOCATION == "Russian Federation"), 63] <- "Russia"
base_efi[which(base_efi$LOCATION == "Trinidad and Tobago"), 63] <- "Trinidad"
base_efi[which(base_efi$LOCATION == "United Kingdom"), 63] <- "UK"
base_efi[which(base_efi$LOCATION == "United States"), 63] <- "USA"
base_efi[which(base_efi$LOCATION == "Brunei Darussalam"), 63] <- "Brunei"
base_efi[which(base_efi$LOCATION == "Congo, Dem. Rep."), 63] <- "Democratic Republic of the Congo"
base_efi[which(base_efi$LOCATION == "Gambia, The"), 63] <- "Gambia"
base_efi[which(base_efi$LOCATION == "Cote d'Ivoire"), 63] <- "Ivory Coast"
base_efi[which(base_efi$LOCATION == "Iran, Islamic Rep."), 63] <- "Iran"
base_efi[which(base_efi$LOCATION == "Kyrgyz Republic"), 63] <- "Kyrgyzstan"
base_efi[which(base_efi$LOCATION == "Lao PDR"), 63] <- "Laos"
base_efi[which(base_efi$LOCATION == "Slovak Republic"), 63] <- "Slovakia"
base_efi[which(base_efi$LOCATION == "Yemen, Rep."), 63] <- "Yemen"


base_map <- base_efi
base_map <- merge(base_map, WorldData, by.x = "region_map", by.y = "region", all.x = T)

```
Ao todo, foram utilizadas informações de 143 países, sendo 70 pobres e 73 não pobres. Os indicadores destes países antes e após a imputação estão exibidos nos Anexo 1 e 2.
Entre os países pobres, todos apresentaram redução na taxa de mortalidade neonatal e na taxa de mortalidade de crianças com idade de 28dias a 5 anos, entre 2016 e 2017. O país pobre com a maior redução na taxa de mortalidade neonatal  foi `r base_efi[which(base_efi$DELTA_RATE_NEO == min(base_efi$DELTA_RATE_NEO)),1]`, com uma variação de `r round(base_efi[which(base_efi$DELTA_RATE_NEO == min(base_efi$DELTA_RATE_NEO)),9],3)`. O país com a menor redução foi `r base_efi[which(base_efi$DELTA_RATE_NEO == max(base_efi$DELTA_RATE_NEO)),1]`, apresentando uma redução de `r round(base_efi[which(base_efi$DELTA_RATE_NEO == max(base_efi$DELTA_RATE_NEO)),9],3)`. Com relação à taxa de mortalidade de crianças com idade entre 28 dias e 5 anos, o pais com a maior redução foi `r base_efi[which(base_efi$DELTA_RATE_NEO_U5 == min(base_efi$DELTA_RATE_NEO_U5)),1]` e com o com a menor `r base_efi[which(base_efi$DELTA_RATE_NEO_U5 == max(base_efi$DELTA_RATE_NEO_U5)),1]`, com variações de `r round(base_efi[which(base_efi$DELTA_RATE_NEO_U5 == min(base_efi$DELTA_RATE_NEO_U5)),11],3)` e `r round(base_efi[which(base_efi$DELTA_RATE_NEO_U5 == max(base_efi$DELTA_RATE_NEO_U5)),11],3)`, respectivamente.
Com relação à variação da entre os gastos públicos (tratamento), todos os países pobres apresentaram aumento entre 2013 e 2014. O país com a maior variação foi `r base_efi[which(base_efi$PUBLIC_EXP_LAGGED2 == max(base_efi$PUBLIC_EXP_LAGGED2)),1]`, US\$`r round(base_efi[which(base_efi$PUBLIC_EXP_LAGGED2 == max(base_efi$PUBLIC_EXP_LAGGED2)),16],2)`; o com amenor foi `r base_efi[which(base_efi$PUBLIC_EXP_LAGGED2 == min(base_efi$PUBLIC_EXP_LAGGED2)),1]`: US\$`r round(base_efi[which(base_efi$PUBLIC_EXP_LAGGED2 == min(base_efi$PUBLIC_EXP_LAGGED2)),16],2)`. A média dos anos de 2011 e 2012 da proporção de pessoas com 65 anos ou mais (variável instrumental) foi maior em  `r base_efi[which(base_efi$PLUS_65_YEARS_LAGGED == max(base_efi$PLUS_65_YEARS_LAGGED)),1]`, `r round(base_efi[which(base_efi$PLUS_65_YEARS_LAGGED == max(base_efi$PLUS_65_YEARS_LAGGED)),17],2)`; e  menor em  `r base_efi[which(base_efi$PLUS_65_YEARS_LAGGED == min(base_efi$PLUS_65_YEARS_LAGGED)),1]`, `r round(base_efi[which(base_efi$PLUS_65_YEARS_LAGGED == min(base_efi$PLUS_65_YEARS_LAGGED)),17],2)`. (Figura 1)

```{r fig.width=12, fig.height=8}
#Neontal, 28d<U5, Tax, Public Expenditure distribution
myPalette_rev <- colorRampPalette(brewer.pal(11, "Spectral")) #Increasing
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")))  #Decreasing

pred_mapa_neo <- dplyr::select(pred_map, c(region_map, DELTA_RATE_NEO))
plot1 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=pred_mapa_neo, map=WorldData,
                  aes(fill= DELTA_RATE_NEO, map_id=region_map),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Var neo 2016-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(100), 
                             labels = round(quantile(pred$DELTA_RATE_NEO, c(.05,.95)),3), 
                             breaks = round(quantile(pred$DELTA_RATE_NEO, c(.05,.95)),3))

pred_mapa_neo_u5 <- dplyr::select(pred_map, c(region_map, DELTA_RATE_NEO_U5))
plot2 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=pred_mapa_neo_u5, map=WorldData,
                  aes(fill= DELTA_RATE_NEO_U5, map_id=region_map),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Var 28d<5y 2016-2017", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(100), 
                             labels = round(quantile(pred$DELTA_RATE_NEO_U5, c(.05,.95)),3), 
                             breaks = round(quantile(pred$DELTA_RATE_NEO_U5, c(.05,.95)),3))

pred_mapa_age <- dplyr::select(pred_map, c(region_map, PLUS_65_YEARS_LAGGED))
plot3 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=pred_mapa_age, map=WorldData,
                  aes(fill= PLUS_65_YEARS_LAGGED, map_id=region_map),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Mean pop>65 2011-2012", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette_rev(100), 
                             labels = round(quantile(pred$PLUS_65_YEARS_LAGGED, c(.05,.95)),3), 
                             breaks = round(quantile(pred$PLUS_65_YEARS_LAGGED, c(.05,.95)),3))

pred_mapa_public <- dplyr::select(pred_map, c(region_map, PUBLIC_EXP_LAGGED2))
plot4 <- ggplot()+
        geom_map(data=WorldData, map=WorldData,
                  aes(x=long, y=lat, group=group, map_id=region),
                  fill="white", colour="#7f7f7f", size=0.5)+
        geom_map(data=pred_mapa_public, map=WorldData,
                  aes(fill= PUBLIC_EXP_LAGGED2, map_id=region_map),
                  colour="#7f7f7f", size=0.5)+
        coord_map("rectangular", lat0=0, xlim=c(-190,190), ylim=c(-60, 90))+
        labs(fill="Var pub exp 2013-2014", x="", y="")+
        theme_bw()+
        theme(panel.border = element_blank())+
        scale_fill_gradientn(colours = myPalette(100), 
                             labels = round(quantile(pred$PUBLIC_EXP_LAGGED2, c(.05,.95)),0), 
                             breaks = round(quantile(pred$PUBLIC_EXP_LAGGED2, c(.05,.95)),0))


ggarrange(plot1, plot2, plot3,plot4, labels = c("A", "B", "C", "D"),
           common.legend = F,legend = "bottom")



```






```{r include=FALSE}
#Association between the treatment and the instrumental variable
instr_treat <- pred_regr <- pred[,c(12:14,16:45)]

t_stat <- lm(PUBLIC_EXP_LAGGED2 ~ ., instr_treat) %>% summary()

t_stat_instr <- t_stat$coefficients[3,3]  #t stat of instrument PLUS_65_YEARS_LAGGED
```

A estatístic t da variável instrumental gregredida sobre a variável de tratamento e condicionada aos fatores extermos foi de `r t_stat_instr`, indicando uma associação adequada. Com base nisso, utilizou-se a variável instrumental para se estimar o efeito da variação do gasto público geral na variação das taxas de mortalidade. Os efeitos e seus intervalos de confiaça, para países pobres estão expressonas na Tabela 1.


```{r effect_predictions}
# Create a table of the effect of the treatment
pred[which(pred$INCOME_CLASS == "L"), 2] <- "Low"
pred[which(pred$INCOME_CLASS == "LM"), 2] <- "Low-Median"
pred[which(pred$INCOME_CLASS == "UM"), 2] <- "Upper-Median"
pred[which(pred$INCOME_CLASS == "H"), 2] <- "High"
pred$INCOME_CLASS <- factor(pred$INCOME_CLASS, levels = c("Low", "Low-Median", "Upper-Median", "High"))
pred$IC_NEO <- paste0("(CI95% ",round(pred$IC_05_NEO,7), " ", round(pred$IC_95_NEO,7),")")
pred$IC_NEO_U5 <- paste0("(CI95% ",round(pred$IC_05_NEO_U5,7), " ", round(pred$IC_95_NEO_U5,7),")")
pred$PRED_NEO <- round(pred$PRED_NEO,7)
pred$PRED_NEO_U5 <- round(pred$PRED_NEO_U5,7)
pred$PRED_NEO <- paste0(pred$PRED_NEO," ",pred$IC_NEO)
pred$PRED_NEO_U5 <- paste0(pred$PRED_NEO_U5," ",pred$IC_NEO_U5)

pred_table <- subset(pred, pred$INCOME_CLASS %in% c("Low", "Low-Median"))
pred_table$DELTA_RATE_NEO <- round(pred_table$DELTA_RATE_NEO,3)
pred_table$DELTA_RATE_NEO_U5 <- round(pred_table$DELTA_RATE_NEO_U5,3)
pred_table$PUBLIC_EXP_LAGGED2 <- round(pred_table$PUBLIC_EXP_LAGGED2,2)
pred_table$PUBLIC_EXP_LAGGED2 <- paste0("US$",pred_table$PUBLIC_EXP_LAGGED2)
                                 
pred_table <- pred_table %>%
     dplyr::select("LOCATION", "DELTA_RATE_NEO", 
                   "DELTA_RATE_NEO_U5", "PUBLIC_EXP_LAGGED2", 
                   "PRED_NEO", "PRED_NEO_U5")

names(pred_table) <- c("Country", "Var Neo", "Var 28d>5y", "Var Public Exp", "Treat Effect Neo", "Treat Effect 28d>5y")

knitr::kable(pred_table)

```


Ao se analisar a relação entre impacto e eficiência, alguns países destacam-se como o Senegal, que aprenseta um baixo desenvolvimento econômico, mas que está acima do percentil 80 tanto em relação à eficiência, quanto ao impacto do governos na mortalidade neonatal e na mortalida de crianças. A distribuição dos países pobres segundo o impacto e a eficiência de seus governos pode ser observado na Figura 2 e os dados na Tabela 2.
```{r fig.width=16, fig.height=8}

effect_effici <- base_efi
effect_effici$IMPACT_NEO <- effect_effici$IMPACT_NEO*-1 #Converting to positive to help the understandig
effect_effici$IMPACT_NEO_U5 <- effect_effici$IMPACT_NEO_U5*-1 #Converting to positive to help the understandig

plot1 <- ggplot(effect_effici,aes(EFI, IMPACT_NEO))+
            geom_text(label = effect_effici$LOCATION,check_overlap = T, size =3)+
            geom_vline(xintercept = quantile(effect_effici$EFI,.8))+
            geom_hline(yintercept = quantile(effect_effici$IMPACT_NEO,.8))+
            #geom_smooth(method = "lm")+
            labs(y = "Impact Neo", x = "Efficiency Neo")+
            theme_bw()
      
plot2 <- ggplot(effect_effici,aes(EFI, IMPACT_NEO_U5))+
            geom_text(label = effect_effici$LOCATION,check_overlap = T, size =3)+
            geom_vline(xintercept = quantile(effect_effici$EFI,.8))+
            geom_hline(yintercept = quantile(effect_effici$IMPACT_NEO_U5,.8))+
            #geom_smooth(method = "lm")+
            labs(y = "Impact 28d>5y", x = "Efficiency 28d>5y")+
            theme_bw()

ggarrange(plot1, plot2, ncol = 2, labels = c("A", "B"))
```


```{r }

lm(EFI ~ IMPACT_NEO*IMPACT_NEO_U5, base_efi) %>%
   summary()


```



#Proportion of Public Health Spending and Efectiveness
##Impact Neo
```{r }

lm(IMPACT_NEO ~ PROP_PUBLIC_HEALTH_EXP_LAGGED2, base_efi) %>%
   summary()

```




##Impact 28d<5y
```{r }

lm(IMPACT_NEO_U5 ~ PROP_PUBLIC_HEALTH_EXP_LAGGED2, base_efi) %>%
   summary()

```




#Proportion of Public Health Spending and Eficiency


```{r }

lm(EFI ~ PROP_PUBLIC_HEALTH_EXP_LAGGED2, base_efi) %>%
   summary() 

```




```{r fig.width=16, fig.height=8}
#Impact measures are multiplied by -1 to help the comprehension

plot1 <- ggplot(effect_effici, aes(PROP_PUBLIC_HEALTH_EXP_LAGGED2,IMPACT_NEO))+
            geom_jitter(aes(color = LOCATION))+
            geom_smooth(method = "lm", se = F)+
            labs(fill="", x="", y="Impact neo")+
            theme_bw()+ 
            theme(legend.position = "none") 
plot2 <- ggplot(effect_effici, aes(PROP_PUBLIC_HEALTH_EXP_LAGGED2,IMPACT_NEO_U5))+
            geom_jitter(aes(color = LOCATION))+
            geom_smooth(method = "lm", se = F)+
            labs(fill="", x="", y="Impact 28d>5y")+
            theme_bw()+ 
            theme(legend.position = "none") 
plot3 <- ggplot(base_efi, aes(PROP_PUBLIC_HEALTH_EXP_LAGGED2,EFI))+
            geom_jitter(aes(color = LOCATION))+
            geom_smooth(method = "lm", se = F)+
            labs(fill="", x="Proportion of Public Expenditure on Health", y="Efficiency")+
            theme_bw()+ 
            theme(legend.position = "none") 
ggarrange(plot1, plot2, plot3, nrow = 3, labels = c("A", "B", "C"))

```


```{r impact_efficiency}
# Create a table of impact and efficiency
base_efi_table <- base_efi
base_efi_table <- base_efi_table %>%
     dplyr::select("LOCATION", "IMPACT_NEO", 
                   "IMPACT_NEO_U5", "EFI", 
                   "PROP_PUBLIC_HEALTH_EXP_LAGGED2")

names(base_efi_table) <- c("Country", "Impact Neo", "Impact 28d>5y", "Efficiency", "Prop Public Exp to Health")

knitr::kable(base_efi_table)

```


